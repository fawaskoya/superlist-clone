generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  name         String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  ownedWorkspaces      Workspace[]
  workspaceMemberships WorkspaceMember[]
  createdLists         List[]
  createdTasks         Task[]
  assignedTasks        Task[]              @relation("AssignedTasks")
  comments             TaskComment[]
  notifications        Notification[]
  activities           TaskActivity[]
  uploadedAttachments  FileAttachment[]
}

model Workspace {
  id        String   @id @default(cuid())
  name      String
  slug      String
  ownerId   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  owner   User              @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  members WorkspaceMember[]
  lists   List[]
  tags    Tag[]
  tasks   Task[]

  @@unique([ownerId, slug])
}

enum Role {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

enum Permission {
  MANAGE_WORKSPACE
  MANAGE_MEMBERS
  MANAGE_LISTS
  CREATE_TASKS
  EDIT_ALL_TASKS
  DELETE_TASKS
  COMMENT_TASKS
  VIEW_ONLY
}

model WorkspaceMember {
  id           String       @id @default(cuid())
  workspaceId  String
  userId       String
  role         Role         @default(MEMBER)
  permissions  String?
  createdAt    DateTime     @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, userId])
}

model List {
  id          String   @id @default(cuid())
  workspaceId String
  name        String
  description String?
  isPersonal  Boolean  @default(false)
  createdById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  createdBy User      @relation(fields: [createdById], references: [id])
  tasks     Task[]
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  DONE
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
}

model Task {
  id           String       @id @default(cuid())
  listId       String?
  title        String
  description  String?
  status       TaskStatus   @default(TODO)
  priority     TaskPriority @default(MEDIUM)
  dueDate      DateTime?
  assignedToId String?
  createdById  String
  parentId     String?
  orderIndex   Float        @default(0)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  workspaceId  String

  list       List?         @relation(fields: [listId], references: [id], onDelete: Cascade)
  workspace  Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  assignedTo User?         @relation("AssignedTasks", fields: [assignedToId], references: [id])
  createdBy  User          @relation(fields: [createdById], references: [id])
  parent     Task?         @relation("TaskSubtasks", fields: [parentId], references: [id], onDelete: Cascade)
  subtasks    Task[]           @relation("TaskSubtasks")
  comments    TaskComment[]
  tags        TaskTag[]
  activities  TaskActivity[]
  attachments FileAttachment[]
}

model TaskComment {
  id        String   @id @default(cuid())
  taskId    String
  authorId  String
  body      String
  createdAt DateTime @default(now())

  task   Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  author User @relation(fields: [authorId], references: [id])
}

model Tag {
  id          String   @id @default(cuid())
  workspaceId String
  name        String
  color       String
  createdAt   DateTime @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  tasks     TaskTag[]

  @@unique([workspaceId, name])
}

model TaskTag {
  id     String @id @default(cuid())
  taskId String
  tagId  String

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  tag  Tag  @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([taskId, tagId])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String
  data      String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

enum ActivityType {
  TASK_CREATED
  TASK_UPDATED
  TASK_DELETED
  TASK_ASSIGNED
  TASK_UNASSIGNED
  TASK_STATUS_CHANGED
  TASK_PRIORITY_CHANGED
  TASK_DUE_DATE_CHANGED
  TASK_MOVED
  SUBTASK_ADDED
  SUBTASK_REMOVED
  COMMENT_ADDED
  TAG_ADDED
  TAG_REMOVED
  FILE_ATTACHED
  FILE_REMOVED
}

model TaskActivity {
  id        String       @id @default(cuid())
  taskId    String
  userId    String
  type      ActivityType
  changes   String?
  metadata  String?
  createdAt DateTime     @default(now())

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id])

  @@index([taskId, createdAt])
}

model FileAttachment {
  id           String   @id @default(cuid())
  taskId       String
  filename     String
  originalName String
  filepath     String
  mimeType     String
  size         Int
  uploadedById String
  createdAt    DateTime @default(now())

  task       Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  uploadedBy User @relation(fields: [uploadedById], references: [id])

  @@index([taskId])
}
